@page "/mycompany"
@using CroBooks.Shared.Dto

@inherits AppComponentBase
@implements IDisposable

<PageHeading>@Localize("MyCompany_Title")</PageHeading>

<MudCard>
    <MudCardContent>
        <CompanyForm @ref="_companyForm" CompanyDto="_companyDto"></CompanyForm>
    </MudCardContent>
    <MudCardActions>
        <MudButton Disabled="@_componentBusy" ButtonType="ButtonType.Submit" Variant="Variant.Filled"
                   Color="Color.Primary" Class="ml-auto" OnClick="@OnSubmit">
            @if (_componentBusy)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2">@LocalizeElement("ButtonProcessing")</MudText>
            }
            else
            {
                <MudText>@LocalizeElement("ButtonSave")</MudText>
            }
        </MudButton>
    </MudCardActions>
</MudCard>

@code {
    [Inject] HttpInterceptorService Interceptor { get; set; } = null!;
    [Inject] CompanyHttpClient CompanyHttpClient { get; set; } = null!;

    private CompanyForm _companyForm = null!;
    private CompanyDto _companyDto = new();
    bool _componentBusy;

    protected override async Task OnInitializedAsync()
    {
        Interceptor.RegisterEvent();
        _companyDto = await CompanyHttpClient.GetDefaultCompany();
    }

    public void Dispose()
    {
        Interceptor.DisposeEvent();
    }

    private async Task OnSubmit()
    {
        if (!_companyForm.Validate())
            return;

        _componentBusy = true;
        _ = await CompanyHttpClient.UpdateCompany(_companyDto);
        _componentBusy = false;
    }

}
